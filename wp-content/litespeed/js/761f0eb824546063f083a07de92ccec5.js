(function($){'use strict';if(typeof abovewpBGE==='undefined'){console.error('AboveWP Bulgarian Eurozone: Missing conversion data');return}
const conversionRate=abovewpBGE.conversionRate;const eurLabel=abovewpBGE.eurLabel;const eurPosition=abovewpBGE.eurPosition||'right';const eurFormat=abovewpBGE.eurFormat||'brackets';function convertBgnToEur(bgnPrice){let normalizedPrice=String(bgnPrice);const decimalMatch=normalizedPrice.match(/[.,](\d{2})$/);if(decimalMatch){const decimalPart=decimalMatch[1];const integerPart=normalizedPrice.substring(0,normalizedPrice.length-3);const cleanIntegerPart=integerPart.replace(/[\s.]/g,'');normalizedPrice=cleanIntegerPart+'.'+decimalPart}else{normalizedPrice=normalizedPrice.replace(/[\s.,]/g,'')}
return(parseFloat(normalizedPrice)/conversionRate).toFixed(2)}
function formatEurPrice(eurPrice){if(eurFormat==='divider'){return'/ '+eurPrice+' '+eurLabel}else{return'('+eurPrice+' '+eurLabel+')'}}
function formatDualPrice(bgnPriceHtml,eurPrice){const eurFormatted=formatEurPrice(eurPrice);const eurSpan='<span class="eur-price">'+eurFormatted+'</span>';if(eurPosition==='left'){return eurSpan+' '+bgnPriceHtml}else{return bgnPriceHtml+' '+eurSpan}}
function hasEurPrice(element){const $element=$(element);if($element.find('.eur-price').length>0||$element.siblings('.eur-price').length>0||$element.next('.eur-price').length>0||$element.prev('.eur-price').length>0){return!0}
if($element.parent().find('.eur-price').length>0){return!0}
if($element.closest('li').find('.eur-price').length>0){return!0}
const text=$element.text();if(text.includes('('+eurLabel+')')||text.includes(eurLabel+')')||text.includes('/ '+eurLabel)||text.includes('/ '+eurLabel+')')){return!0}
if($element.closest('.mini_cart_item').length>0&&$element.closest('.mini_cart_item').find('.eur-price').length>0){return!0}
return!1}
function addEurPrice(element){if(hasEurPrice(element)){return}
const $element=$(element);const text=$element.text().trim();const pricePattern=/(\d+(?:[\s.]\d{3})*[.,]\d{2})\s*(?:лв\.|BGN)?/;const match=text.match(pricePattern);if(match){const priceBgn=match[1];const priceEur=convertBgnToEur(priceBgn);const $eurSpan=$('<span class="eur-price">'+formatEurPrice(priceEur)+'</span>');if(eurPosition==='left'){$element.prepend($eurSpan).prepend(' ')}else{$element.append(' ').append($eurSpan)}}}
function replaceDualPrice(element){if(hasEurPrice(element)){return}
const $element=$(element);const originalHtml=$element.html();const text=$element.text().trim();const pricePattern=/(\d+(?:[\s.]\d{3})*[.,]\d{2})\s*(?:лв\.|BGN)?/;const match=text.match(pricePattern);if(match){const priceBgn=match[1];const priceEur=convertBgnToEur(priceBgn);const dualPriceHtml=formatDualPrice(originalHtml,priceEur);$element.html(dualPriceHtml)}}
function processCartItemPrices(){$('.wc-block-components-product-price').each(function(){if($(this).text().includes('–')||$(this).text().includes('-')){addEurPrice(this)}else{replaceDualPrice(this)}});$('.wc-block-cart-item__total-price-and-sale-badge-wrapper .wc-block-components-product-price').each(function(){replaceDualPrice(this)})}
function processCartTotals(){$('.wc-block-components-totals-item__value').each(function(){replaceDualPrice(this)});$('.wc-block-components-totals-footer-item .wc-block-components-totals-item__value').each(function(){replaceDualPrice(this)})}
function processShippingMethods(){$('#shipping_method li, .woocommerce-shipping-methods li').each(function(){var $li=$(this);var labelText=$li.find('label').text();if(labelText&&(labelText.indexOf('€')!==-1||labelText.indexOf('EUR')!==-1)){return}
var $priceSpan=$li.find('.woocommerce-Price-amount');if($priceSpan.length>0){$priceSpan.each(function(){var $this=$(this);var text=$this.text().trim();var html=$this.html();if(!text||text.indexOf(eurLabel)!==-1){return}
var priceMatch=text.match(/(\d+(?:[,\s.]\d{3})*[,\.]\d{2})\s*(?:лв\.|BGN)?/)||html.match(/(\d+(?:[,\s.&nbsp;]\d{3})*[,\.]\d{2})\s*(?:лв\.|BGN)?/);if(priceMatch){var priceBgnRaw=priceMatch[1];var priceBgn=priceBgnRaw.replace(/&nbsp;/g,'').replace(/\s/g,'').replace(',','.');var currentPriceEur=(parseFloat(priceBgn)/conversionRate).toFixed(2);var $existingEurSpan=$li.find('.eur-price');if($existingEurSpan.length>0){var existingEurText=$existingEurSpan.text();var existingEurMatch=existingEurText.match(/(\d+[.,]\d{2})/);if(existingEurMatch){var existingEurPrice=existingEurMatch[1].replace(',','.');if(Math.abs(parseFloat(currentPriceEur)-parseFloat(existingEurPrice))>0.01){$existingEurSpan.remove()}else{return}}else{$existingEurSpan.remove()}}
var eurFormatted=formatEurPrice(currentPriceEur);var eurSpan='<span class="eur-price">'+eurFormatted+'</span>';if(eurPosition==='left'){$this.before(eurSpan+' ')}else{$this.after(' '+eurSpan)}}})}})}
function processCartFees(){$('.fee .woocommerce-Price-amount').each(function(){if(!hasEurPrice(this)){addEurPrice(this)}})}
function processCheckoutBlockShipping(){$('.wc-block-components-radio-control__option').each(function(){var $option=$(this);if($option.find('.eur-price').length>0){return}
var $priceElement=$option.find('.wc-block-formatted-money-amount.wc-block-components-formatted-money-amount');if($priceElement.length>0){$priceElement.each(function(){var $this=$(this);var text=$this.text().trim();if(!text||text.indexOf(eurLabel)!==-1||text.toLowerCase().indexOf('безплатно')!==-1||text.toLowerCase().indexOf('free')!==-1){return}
var priceMatch=text.match(/(\d+(?:[,\s.]\d{3})*[,]\d{2})\s*(?:лв\.|BGN)?/);if(priceMatch){var priceBgn=priceMatch[1].replace(/\s/g,'').replace(',','.');var priceEur=(parseFloat(priceBgn)/conversionRate).toFixed(2);var eurFormatted=formatEurPrice(priceEur);var eurSpan='<span class="eur-price">'+eurFormatted+'</span>';if(eurPosition==='left'){$this.before(eurSpan+' ')}else{$this.after(' '+eurSpan)}}})}});$('.wc-block-components-totals-shipping .wc-block-formatted-money-amount, .wc-block-components-totals-item .wc-block-components-totals-item__value').each(function(){var $this=$(this);var $totalsItem=$this.closest('.wc-block-components-totals-item');if($totalsItem.length>0){var labelText=$totalsItem.find('.wc-block-components-totals-item__label').text().toLowerCase();if(labelText.indexOf('доставка')===-1&&labelText.indexOf('shipping')===-1&&labelText.indexOf('delivery')===-1){return}}
if(!hasEurPrice(this)){var text=$this.text().trim();if(text&&text.indexOf(eurLabel)===-1&&text.toLowerCase().indexOf('безплатно')===-1&&text.toLowerCase().indexOf('free')===-1){var priceMatch=text.match(/(\d+(?:[,\s.]\d{3})*[,]\d{2})\s*(?:лв\.|BGN)?/);if(priceMatch){var priceBgn=priceMatch[1].replace(/\s/g,'').replace(',','.');var priceEur=(parseFloat(priceBgn)/conversionRate).toFixed(2);var eurFormatted=formatEurPrice(priceEur);var eurSpan='<span class="eur-price">'+eurFormatted+'</span>';if(eurPosition==='left'){$this.before(eurSpan+' ')}else{$this.after(' '+eurSpan)}}}}})}
function processAllPrices(){processCartItemPrices();processCartTotals();processShippingMethods();processCheckoutBlockShipping();processCartFees();$('.widget_shopping_cart .mini_cart_item .quantity').each(function(){if(!hasEurPrice(this)){addEurPrice(this)}})}
function init(){processAllPrices();const observer=new MutationObserver(function(mutations){var shouldProcess=!1;mutations.forEach(function(mutation){if(mutation.type==='childList'){if(mutation.target.querySelector&&(mutation.target.querySelector('.woocommerce-Price-amount')||mutation.target.querySelector('#shipping_method')||mutation.target.querySelector('.wc-block-formatted-money-amount')||mutation.target.querySelector('.wc-block-components-radio-control__option')||mutation.target.id==='shipping_method'||mutation.target.classList.contains('woocommerce-shipping-totals')||mutation.target.classList.contains('woocommerce-shipping-methods')||mutation.target.classList.contains('wc-block-components-shipping-rates-control')||mutation.target.classList.contains('wc-block-checkout__shipping-option')||mutation.target.classList.contains('wc-block-components-totals-item')||mutation.target.classList.contains('wc-block-components-totals-item__value'))){shouldProcess=!0}
if(mutation.addedNodes&&mutation.addedNodes.length>0){for(var i=0;i<mutation.addedNodes.length;i++){var node=mutation.addedNodes[i];if(node.nodeType===Node.ELEMENT_NODE){if(node.querySelector&&(node.querySelector('.woocommerce-Price-amount')||node.querySelector('#shipping_method')||node.classList.contains('woocommerce-shipping-methods')||node.id==='shipping_method')){shouldProcess=!0;break}}}}}else if(mutation.type==='characterData'){var target=mutation.target.parentElement;if(target&&(target.classList.contains('woocommerce-Price-amount')||target.querySelector('.woocommerce-Price-amount'))){shouldProcess=!0}}});if(shouldProcess){setTimeout(function(){processAllPrices();setTimeout(processAllPrices,100)},50)}});const containers=document.querySelectorAll('.wp-block-woocommerce-cart, '+'.wp-block-woocommerce-checkout, '+'.wp-block-woocommerce-mini-cart, '+'.widget_shopping_cart, '+'.woocommerce-shipping-totals, '+'.woocommerce-shipping-methods, '+'.wc-block-checkout__shipping-option, '+'.wc-block-components-shipping-rates-control, '+'.wc-block-components-totals-wrapper, '+'.wc-block-components-totals-item, '+'#shipping_method');const parentContainers=document.querySelectorAll('.woocommerce-checkout-review-order-table, '+'.woocommerce-checkout-review-order, '+'.shop_table_responsive, '+'.cart_totals');for(const container of containers){observer.observe(container,{childList:!0,subtree:!0,characterData:!0,attributes:!0,attributeFilter:['class','data-title']})}
for(const parentContainer of parentContainers){observer.observe(parentContainer,{childList:!0,subtree:!0,characterData:!0})}
const forms=document.querySelectorAll('.woocommerce-cart-form, .woocommerce-checkout');for(const form of forms){if(form){observer.observe(form,{childList:!0,subtree:!0,characterData:!0})}}
$(document).on('wc-blocks-cart-update wc-blocks-checkout-update',function(){setTimeout(processAllPrices,100)});$(document).on('change','.wc-block-components-radio-control__input',function(){setTimeout(processAllPrices,150)});$(document).on('change','.wc-block-components-quantity-selector__input',function(){setTimeout(processAllPrices,100)});$(document).on('click','.wc-block-components-quantity-selector__button',function(){setTimeout(processAllPrices,100)});$(document).on('added_to_cart removed_from_cart updated_cart_totals',function(){setTimeout(processAllPrices,100)});$(document).on('change','input[name^="shipping_method"]',function(){setTimeout(processAllPrices,100)});$(document).on('updated_checkout',function(){setTimeout(processAllPrices,150)});$(document).on('updated_shipping_method',function(){setTimeout(processAllPrices,100)});$(document).ajaxComplete(function(event,xhr,settings){if(settings.url&&(settings.url.indexOf('wc-ajax=')>-1||settings.url.indexOf('update_order_review')>-1||settings.url.indexOf('get_refreshed_fragments')>-1||settings.url.indexOf('shipping')>-1||settings.url.indexOf('speedy')>-1||(settings.data&&typeof settings.data==='string'&&settings.data.indexOf('shipping')>-1))){setTimeout(function(){processAllPrices();setTimeout(function(){if($('#shipping_method .woocommerce-Price-amount').length>0&&$('#shipping_method .eur-price').length===0){processShippingMethods()}},200)},100)}});$(document).on('DOMNodeInserted','#shipping_method',function(){setTimeout(function(){processShippingMethods()},50)});if(document.querySelector('.woocommerce-cart, .woocommerce-checkout')){setInterval(function(){var needsUpdate=!1;$('#shipping_method li, .woocommerce-shipping-methods li').each(function(){var $li=$(this);var $priceSpan=$li.find('.woocommerce-Price-amount');var $eurSpan=$li.find('.eur-price');var labelText=$li.find('label').text();if($priceSpan.length>0&&$eurSpan.length===0&&(!labelText||(labelText.indexOf('€')===-1&&labelText.indexOf('EUR')===-1))){var text=$priceSpan.text().trim();if(text&&text.match(/\d+[,]\d{2}\s*(?:лв\.|BGN)?/)){needsUpdate=!0;return!1}}});if(needsUpdate){processAllPrices()}},2000)}}
$(document).ready(init);$(window).on('load',processAllPrices)})(jQuery)
;